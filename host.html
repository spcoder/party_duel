<title>Host | Family Duel</title>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.33.1.min.js"></script>
<script src="js/util.js"></script>
<script src="js/net.js"></script>
<script src="js/engine.js"></script>

<script>
  console.log('script loaded');

  const renderTeamNameForm = (el, context) => {
    el.querySelector('h2').innerText = context.title;
    const input = el.querySelector('input');
    input.value = Reflect.get(state, context.prop);
    el.querySelector('form').addEventListener('submit', e => {
      e.preventDefault();
      Reflect.set(state, context.prop, e.target.querySelector('input').value);
      state._view = viewEnum.board;
    });
    return () => {
      input.select();
      input.focus();
    };
  };

  const renderQuestionForm = (el) => {
    const question = el.querySelector('input[name=question]');
    const answers = Array(8).fill(null).reduce((acc, _, i) => acc.concat(el.querySelector(`input[name=answer${i + 1}Text]`)), []);
    const scores = Array(8).fill(null).reduce((acc, _, i) => acc.concat(el.querySelector(`input[name=answer${i + 1}Score]`)), []);
    question.value = state.question;
    answers.forEach((a, i) => a.value = Reflect.get(state, `answer${i + 1}Text`));
    scores.forEach((s, i) => s.value = Reflect.get(state, `answer${i + 1}Score`));
    el.querySelector('form').addEventListener('submit', e => {
      e.preventDefault();
      const { submitter } = e;
      if (submitter.innerText === 'Cancel') {
        state._view = viewEnum.board;
        return;
      }
      state.question = question.value;
      const sanitize = t => t.trim() === '' ? null : t;
      // TODO: batch these up so that only one publish occurs
      answers.forEach((a, i) => Reflect.set(state, `answer${i + 1}Text`, sanitize(a.value)));
      scores.forEach((s, i) => Reflect.set(state, `answer${i + 1}Score`, sanitize(s.value)));
      state._view = viewEnum.board;
    });
    return () => {
      question.focus();
    };
  };

  const renderScoreForm = (el, { teamNumber }) => {
    el.querySelector('h2').innerText = Reflect.get(state, 'teamName' + teamNumber) + ' - Score';
    const input = el.querySelector('input');
    input.value = Reflect.get(state, 'teamScore' + teamNumber);
    el.querySelector('form').addEventListener('submit', e => {
      e.preventDefault();
      const sanitize = t => {
        if (t.trim() === '') {
          return 0;
        }
        const n = parseFloat(t);
        if (isNaN(n)) {
          return 0;
        }
        return n;
      };
      Reflect.set(state, 'teamScore' + teamNumber, sanitize(e.target.querySelector('input').value));
      state._view = viewEnum.board;
    });
    return () => {
      input.select();
      input.focus();
    };
  };

  const renderStrikeConfirmation = (el) => {
    const action = state.$modalContext > 0 ? 'Add' : 'Remove';
    el.querySelector('h2').innerText = `${action} Strike?`;
    el.querySelector('.message').innerText = `Are you sure you want to ${action.toLowerCase()} a strike?`;
    el.querySelector('button[name=confirm]').innerText = `Yes, ${action.toLowerCase()} strike`;
    el.querySelector('button[name=cancel]').innerText = 'Nevermind';
    el.querySelector('form').addEventListener('submit', e => {
      e.preventDefault();
      const { submitter } = e;
      if (submitter.name === 'cancel') {
        state._view = viewEnum.board;
        return;
      }
      if (state.$modalContext > 0 && state.strikes < 3) {
        state.strikes++;
      } else if (state.$modalContext < 0 && state.strikes > 0) {
        state.strikes--;
      }
      state._view = viewEnum.board;
    });
  };

  const renderToggleVisibleConfirmation = (el) => {
    const answerText = Reflect.get(state, `answer${state.$modalContext}Text`);
    const answerScore = Reflect.get(state, `answer${state.$modalContext}Score`);
    const answerVisibility = Reflect.get(state, `answer${state.$modalContext}Visible`);
    const action = answerVisibility ? 'Hide' : 'Show';
    el.querySelector('h2').innerText = `${action} Answer?`;
    el.querySelector('.message').innerText = `Are you sure you want to ${action.toLowerCase()} the answer below?`;
    el.querySelector('.context').innerText = `${answerText} for ${answerScore} points.`;
    el.querySelector('button[name=confirm]').innerText = `Yes, ${action.toLowerCase()} answer`;
    el.querySelector('button[name=cancel]').innerText = 'Nevermind';
    el.querySelector('form').addEventListener('submit', e => {
      e.preventDefault();
      const { submitter } = e;
      if (submitter.name === 'cancel') {
        state._view = viewEnum.board;
        return;
      }
      Reflect.set(state, `answer${state.$modalContext}Visible`, !answerVisibility);
      state._view = viewEnum.board;
    });
  };

  const views = {
    board: { templateId: 'board', renderer: 'renderBoard' },
    teamName1Form: { templateId: 'teamNameForm', renderer: renderTeamNameForm, context: { title: 'Team 1', prop: 'teamName1' } },
    teamName2Form: { templateId: 'teamNameForm', renderer: renderTeamNameForm, context: { title: 'Team 2', prop: 'teamName2' } },
    questionForm: { templateId: 'questionForm', renderer: renderQuestionForm },
    teamScore1Form: { templateId: 'scoreForm', renderer: renderScoreForm, context: { teamNumber: 1 } },
    teamScore2Form: { templateId: 'scoreForm', renderer: renderScoreForm, context: { teamNumber: 2 } },
    strikeConfirmation: { templateId: 'strikeConfirmation', renderer: renderStrikeConfirmation },
    toggleVisibleConfirmation: { templateId: 'toggleVisibleConfirmation', renderer: renderToggleVisibleConfirmation },
  };

  const toggleAnswerVisibility = (index) => {
    state.$modalContext = index;
    state._view = viewEnum.toggleVisibleConfirmation;
  };

  const incrementStrikes = () => {
    state.$modalContext = 1;
    state._view = viewEnum.strikeConfirmation;
  };

  const decrementStrikes = () => {
    state.$modalContext = -1;
    state._view = viewEnum.strikeConfirmation;
  };

  const viewEnum = Object.freeze({
    board: 'board',
    teamName1Form: 'teamName1Form',
    teamName2Form: 'teamName2Form',
    questionForm: 'questionForm',
    teamScore1Form: 'teamScore1Form',
    teamScore2Form: 'teamScore2Form',
    strikeConfirmation: 'strikeConfirmation',
    toggleVisibleConfirmation: 'toggleVisibleConfirmation',
  });

  const broadcastViewEnum = Object.freeze({
    board: 'board',
    score: 'score',
    wait: 'wait',
  });

  const state = new Proxy({
    // non-reactive
    $modalContext: undefined,

    // reactive: watchable, savable
    _userId: loadData('_userId', uuid()),
    _joinCode: loadData('_joinCode', generateJoinCode()),
    _view: loadData('_view', viewEnum.board),

    // reactive: watchable, savable, publishable
    started: false,
    broadcastView: loadData('broadcastView', broadcastViewEnum.board),
    teamName1: loadData('teamName1', 'Team 1'),
    teamScore1: loadNumber('teamScore1', 0),
    teamName2: loadData('teamName2', 'Team 2'),
    teamScore2: loadNumber('teamScore2', 0),
    strikes: loadNumber('strikes', 0),
    question: loadData('question', null),
    answer1Text: loadData('answer1Text', null),
    answer1Score: loadData('answer1Score', null),
    answer1Visible: loadBoolean('answer1Visible', false),
    answer2Text: loadData('answer2Text', null),
    answer2Score: loadData('answer2Score', null),
    answer2Visible: loadBoolean('answer2Visible', false),
    answer3Text: loadData('answer3Text', null),
    answer3Score: loadData('answer3Score', null),
    answer3Visible: loadBoolean('answer3Visible', false),
    answer4Text: loadData('answer4Text', null),
    answer4Score: loadData('answer4Score', null),
    answer4Visible: loadBoolean('answer4Visible', false),
    answer5Text: loadData('answer5Text', null),
    answer5Score: loadData('answer5Score', null),
    answer5Visible: loadBoolean('answer5Visible', false),
    answer6Text: loadData('answer6Text', null),
    answer6Score: loadData('answer6Score', null),
    answer6Visible: loadBoolean('answer6Visible', false),
    answer7Text: loadData('answer7Text', null),
    answer7Score: loadData('answer7Score', null),
    answer7Visible: loadBoolean('answer7Visible', false),
    answer8Text: loadData('answer8Text', null),
    answer8Score: loadData('answer8Score', null),
    answer8Visible: loadBoolean('answer8Visible', false),
  }, engine);

  window.addEventListener('DOMContentLoaded', async () => {
    console.log('DOMContentLoaded');
    await Promise.all([
      includeTemplate('board.html'),
      includeTemplate('score_form.html'),
      includeTemplate('team_name_form.html'),
      includeTemplate('question_form.html'),
      includeTemplate('strike_confirmation.html'),
      includeTemplate('toggle_visible_confirmation.html')
    ]);

    networking.start(state._userId, state._joinCode);
    networking.addListener(e => {
      if (e.message === 'canhazit?') {
        publishState(state);
      }
    });

    state.started = true; // turn the key to start the engine
  });
</script>

<h1>Host</h1>
<button onclick="state.broadcastView = broadcastViewEnum.board;">Board</button>
<button onclick="state.broadcastView = broadcastViewEnum.score;">Score</button>
<button onclick="state.broadcastView = broadcastViewEnum.wait;">Wait</button>
<div id="viewContainer"></div>
