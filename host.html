<title>Host | Family Duel</title>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.33.1.min.js"></script>
<script>
  console.log('script loaded');

  const uuid = () => {
    const uuid = new Uint32Array(3);
    crypto.getRandomValues(uuid);
    return uuid.join('');
  };

  const generateGameCode = () => {
    const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
    const numbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
    const randomLetter = () => letters[Math.floor(Math.random() * letters.length)];
    const randomNumber = () => numbers[Math.floor(Math.random() * numbers.length)];
    const lengthOfCode = 5;
    let code = '';
    for (let i = 0; i < lengthOfCode; i++) {
      code += (i % 2 === 0) ? randomLetter() : randomNumber();
    }
    return code;
  };

  const getData = (key, def) => {
    let value = localStorage.getItem(key);
    if (!value) {
      value = def;
      localStorage.setItem(key, value);
    }
    return value;
  };

  const setData = (key, value) => {
    localStorage.setItem(key, value);
  };

  class Host {
    constructor(userId) {
      this.userId = userId;
      // this.pubnub = new PubNub({
      //   publishKey: "pub-c-c20b0062-2fab-478d-b3a0-df24b3ad656f",
      //   subscribeKey: "sub-c-e4bd8c4a-3e23-11ec-b2c1-a25c7fcd9558",
      //   uuid: this.userId
      // });
    }

    statusChanged(event) {
      console.log('statusChanged', event);
      // if (event.category === "PNConnectedCategory") {
      // }
    }

    messageReceived(message) {
      console.log('messageReceived', message);
    }

    presenceChanged(event) {
      console.log('presenceChanged', event);
    }

    start(gameCode) {
      console.log('start', gameCode);
      this.gameCode = gameCode;
      // this.pubnub.addListener({
      //   status: this.statusChanged,
      //   message: this.messageReceived,
      //   presence: this.presenceChanged
      // });
      // this.pubnub.subscribe({ channels: [this.gameCode] });
    }

    render() {
      console.log('render');
      document.getElementById('gameCode').innerText = this.gameCode;
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    console.log('dom content loaded');

    const gameCode = getData('gameCode', generateGameCode());
    const userId = getData('userId', uuid());

    const host = new Proxy(new Host(userId), {
      set(target, prop, value) {
        const result = Reflect.set(...arguments);
        if (result && prop === 'gameCode') {
          target.render();
        }
        return result;
      }
    });

    host.start(gameCode);
  });
</script>

<h1>Host</h1>
<div id="gameCode"></div>
