<title>Host | Party Duel</title>
<link rel="stylesheet" href="reset.css">
<link rel="stylesheet" href="index.css">
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.33.1.min.js"></script>
<script src="js/util.js"></script>
<script src="js/net.js"></script>
<script src="js/engine.js"></script>

<div id="app"></div>

<script>
  const app = useEngine('app', {
    routes: {
      menu: { file: 'views/menu.html', templateId: 'menuView' },
      board: { file: 'views/board.html', templateId: 'boardView' },
      teamName1Form: { file: 'views/team_name_form.html', templateId: 'teamNameFormView', context: { title: 'Team 1', prop: 'teamName1' } },
      teamName2Form: { file: 'views/team_name_form.html', templateId: 'teamNameFormView', context: { title: 'Team 2', prop: 'teamName2' } },
      questionForm: { file: 'views/question_form.html', templateId: 'questionFormView' },
      teamScore1Form: { file: 'views/score_form.html', templateId: 'scoreFormView', context: { teamNumber: 1 } },
      teamScore2Form: { file: 'views/score_form.html', templateId: 'scoreFormView', context: { teamNumber: 2 } },
      strikeConfirmation: { file: 'views/strike_confirmation.html', templateId: 'strikeConfirmationView' },
      toggleVisibleConfirmation: { file: 'views/toggle_visible_confirmation.html', templateId: 'toggleVisibleConfirmationView' },
    },
    routeDefault: 'menu',
    routeNotFound: 'menu',
    defaultState: {
      // not publishable
      _userId: uuid(),
      _joinCode: generateJoinCode(),
      // publishable
      broadcastView: 'board',
      teamName1: 'Team 1',
      teamScore1: 0,
      teamName2: 'Team 2',
      teamScore2: 0,
      strikesModalDirection: undefined,
      visibilityConfirmationIndex: undefined,
      strikes: 0,
      question: undefined,
      answer1Text: undefined,
      answer1Score: undefined,
      answer1Visible: false,
      answer2Text: undefined,
      answer2Score: undefined,
      answer2Visible: false,
      answer3Text: undefined,
      answer3Score: undefined,
      answer3Visible: false,
      answer4Text: undefined,
      answer4Score: undefined,
      answer4Visible: false,
      answer5Text: undefined,
      answer5Score: undefined,
      answer5Visible: false,
      answer6Text: undefined,
      answer6Score: undefined,
      answer6Visible: false,
      answer7Text: undefined,
      answer7Score: undefined,
      answer7Visible: false,
      answer8Text: undefined,
      answer8Score: undefined,
      answer8Visible: false,
    },
    state: {
      // not publishable
      _userId: loadData('_userId', uuid()),
      _joinCode: loadData('_joinCode', generateJoinCode()),
      // publishable
      broadcastView: loadData('broadcastView', 'board'),
      teamName1: loadData('teamName1', 'Team 1'),
      teamScore1: loadNumber('teamScore1', 0),
      teamName2: loadData('teamName2', 'Team 2'),
      teamScore2: loadNumber('teamScore2', 0),
      strikesModalDirection: loadNumber('strikesModalDirection', null),
      visibilityConfirmationIndex: loadNumber('visibilityConfirmationIndex', null),
      strikes: loadNumber('strikes', 0),
      question: loadData('question', null),
      answer1Text: loadData('answer1Text', null),
      answer1Score: loadNumber('answer1Score', null),
      answer1Visible: loadBoolean('answer1Visible', false),
      answer2Text: loadData('answer2Text', null),
      answer2Score: loadNumber('answer2Score', null),
      answer2Visible: loadBoolean('answer2Visible', false),
      answer3Text: loadData('answer3Text', null),
      answer3Score: loadNumber('answer3Score', null),
      answer3Visible: loadBoolean('answer3Visible', false),
      answer4Text: loadData('answer4Text', null),
      answer4Score: loadNumber('answer4Score', null),
      answer4Visible: loadBoolean('answer4Visible', false),
      answer5Text: loadData('answer5Text', null),
      answer5Score: loadNumber('answer5Score', null),
      answer5Visible: loadBoolean('answer5Visible', false),
      answer6Text: loadData('answer6Text', null),
      answer6Score: loadNumber('answer6Score', null),
      answer6Visible: loadBoolean('answer6Visible', false),
      answer7Text: loadData('answer7Text', null),
      answer7Score: loadNumber('answer7Score', null),
      answer7Visible: loadBoolean('answer7Visible', false),
      answer8Text: loadData('answer8Text', null),
      answer8Score: loadNumber('answer8Score', null),
      answer8Visible: loadBoolean('answer8Visible', false),
    },
    afterStateChange: function(prop, oldValue, newValue, state) {
      // save
      saveData(prop, newValue);
      // detect channel change
      if (prop === '_joinCode') {
        networking.unsubscribe(oldValue);
        networking.subscribe(newValue);
      }
      // publish
      if (!prop.startsWith('_')) {
        publishState(state._joinCode, state);
      }
    },
    afterStart: function(state) {
      document.addEventListener('touchstart', () => {
        // ignore. useful for mobile to show :active normally
      }, false);
      networking.start(state._userId, state._joinCode);
      networking.addListener(e => {
        if (e.message === 'canhazit?') {
          publishState(state._joinCode, state);
        }
      });
    }
  });
</script>
